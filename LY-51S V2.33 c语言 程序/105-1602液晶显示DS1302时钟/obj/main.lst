C51 COMPILER V8.02   MAIN                                                                  09/18/2010 23:34:57 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\obj\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\obj\main.lst) OBJECT(.\obj\main.ob
                    -j)

line level    source

   1          /*-----------------------------------------------
   2            Ãû³Æ£ºDS1302Ê±ÖÓÊıÂë¹ÜÏÔÊ¾ ´®¿Ú¸üĞÂ
   3            ÂÛÌ³£ºwww.doflye.net
   4            ±àĞ´£ºshifang
   5            ÈÕÆÚ£º2009.5
   6            ĞŞ¸Ä£ºÎŞ
   7            ÄÚÈİ£ºÒº¾§ÏÔÊ¾Ê±¼ä
   8                          Í¨¹ıdofly×Ô´øµÄ´®¿Úµ÷ÊÔÈí¼ş£¬´ò¿ª´®¿Ú£¬²¨ÌØÂÊÄ¬ÈÏ9600£¬µã»÷¸üĞÂÊ±¼ä¼´¿É£¬Èç¹û²»ĞĞ£¬°´ÏÂ¿ª·¢°å¸´Î»ÖØĞÂ¸üĞ
             -Â
   9          ------------------------------------------------*/
  10          #include<reg52.h> //°üº¬Í·ÎÄ¼ş£¬Ò»°ãÇé¿ö²»ĞèÒª¸Ä¶¯£¬Í·ÎÄ¼ş°üº¬ÌØÊâ¹¦ÄÜ¼Ä´æÆ÷µÄ¶¨Òå
  11          #include <stdio.h>
  12          #include "ds1302.h"
  13          #include "delay.h"
  14          #include "1602.h"
  15          
  16          bit ReadTimeFlag;//¶¨Òå¶ÁÊ±¼ä±êÖ¾
  17          bit SetFlag;     //¸üĞÂÊ±¼ä±êÖ¾Î»
  18          unsigned char time_buf2[16];
  19          
  20          void Init_Timer0(void);//¶¨Ê±Æ÷³õÊ¼»¯
  21          void UART_Init(void);
  22          /*------------------------------------------------
  23                              Ö÷º¯Êı
  24          ------------------------------------------------*/
  25          void main (void)
  26          {
  27   1      unsigned char i;                  
  28   1      unsigned char temp[16];//¶¨ÒåÏÔÊ¾ÇøÓòÁÙÊ±´æ´¢Êı×é
  29   1      
  30   1      LCD_Init();           //³õÊ¼»¯Òº¾§
  31   1      DelayMs(20);          //ÑÓÊ±ÓĞÖúÓÚÎÈ¶¨
  32   1      LCD_Clear();          //ÇåÆÁ
  33   1      Init_Timer0();        //¶¨Ê±Æ÷0³õÊ¼»¯
  34   1      Ds1302_Init();        //ds1302³õÊ¼»¯
  35   1      UART_Init();          //´®¿Ú³õÊ¼»¯
  36   1      
  37   1      Ds1302_Read_Time();   //Ê×´Î¶ÁÈ¡Ê±¼ä
  38   1      if((time_buf1[2]+time_buf1[7])==0) //Èç¹ûËùÓĞ²ÎÊı¶¼Îª0£¬Ğ´ÈëÒ»¸ö³õÊ¼Öµ
  39   1         Ds1302_Write_Time();    
  40   1      while (1)         //Ö÷Ñ­»·
  41   1        {
  42   2      
  43   2      
  44   2      if(SetFlag)     //Èç¹û½ÓÊÕµ½´®¿ÚĞÅÏ¢Ôò¸üĞÂÊ±ÖÓ
  45   2        {
  46   3              for(i=0;i<8;i++)
  47   3                      {
  48   4                      time_buf1[i]=time_buf2[2*i]*10+time_buf2[2*i+1];//Êı¾İÕûºÏ£¬Èç2¸öÊı 1ºÍ5ÕûºÏ³É15
  49   4                      }
  50   3                      Ds1302_Write_Time();//½ÓÊÕ¸üĞÂµÄÊ±¼äÈ»ºóĞ´Èëds1302
  51   3                      SetFlag=0;          //Ê±ÖÓĞÅÏ¢¸üĞÂºó±êÖ¾Î»ÇåÁã
  52   3         }
  53   2      
C51 COMPILER V8.02   MAIN                                                                  09/18/2010 23:34:57 PAGE 2   

  54   2      
  55   2      if(ReadTimeFlag==1) //¶¨Ê±¶ÁÈ¡ds1302 ¶¨Ê±Ê±¼äµ½ Ôò±êÖ¾Î»ÖÃ1£¬´¦Àí¹ıÊ±¼ä²ÎÊı±êÖ¾Î»ÇåÁã
  56   2      {
  57   3        ReadTimeFlag=0;  //±êÖ¾Î»ÇåÁã
  58   3        Ds1302_Read_Time();//¶ÁÈ¡Ê±¼ä²ÎÊı
  59   3        sprintf(temp,"DATE %02d-%02d-%02d %d",(int)time_buf1[1],(int)time_buf1[2],(int)time_buf1[3],(int)time_bu
             -f1[7]);//ÄêÔÂÈÕÖÜ
  60   3        LCD_Write_String(0,0,temp);//ÏÔÊ¾µÚÒ»ĞĞ
  61   3        sprintf(temp,"TIME %02d:%02d:%02d",(int)time_buf1[4],(int)time_buf1[5],(int)time_buf1[6]);//Ê±·ÖÃë
  62   3        LCD_Write_String(0,1,temp);//ÏÔÊ¾µÚ¶şĞĞ
  63   3        }
  64   2       }
  65   1      }
  66          /*------------------------------------------------
  67                        ´®¿ÚÍ¨Ñ¶³õÊ¼»¯
  68          ------------------------------------------------*/
  69          void UART_Init(void)
  70          {
  71   1          SCON  = 0x50;                       // SCON: Ä£Ê½ 1, 8-bit UART, Ê¹ÄÜ½ÓÊÕ  
  72   1          TMOD |= 0x20;               // TMOD: timer 1, mode 2, 8-bit ÖØ×°
  73   1          TH1   = 0xFD;               // TH1:  ÖØ×°Öµ 9600 ²¨ÌØÂÊ ¾§Õñ 11.0592MHz  
  74   1          TR1   = 1;                  // TR1:  timer 1 ´ò¿ª                         
  75   1          EA    = 1;                  //´ò¿ª×ÜÖĞ¶Ï
  76   1          ES    = 1;                  //´ò¿ª´®¿ÚÖĞ¶Ï
  77   1      }
  78          
  79          /*------------------------------------------------
  80                              ¶¨Ê±Æ÷³õÊ¼»¯×Ó³ÌĞò
  81          ------------------------------------------------*/
  82          void Init_Timer0(void)
  83          {
  84   1       TMOD |= 0x01;    //Ê¹ÓÃÄ£Ê½1£¬16Î»¶¨Ê±Æ÷£¬Ê¹ÓÃ"|"·ûºÅ¿ÉÒÔÔÚÊ¹ÓÃ¶à¸ö¶¨Ê±Æ÷Ê±²»ÊÜÓ°Ïì                 
  85   1       //TH0=0x00;          //¸ø¶¨³õÖµ
  86   1       //TL0=0x00;
  87   1       EA=1;            //×ÜÖĞ¶Ï´ò¿ª
  88   1       ET0=1;           //¶¨Ê±Æ÷ÖĞ¶Ï´ò¿ª
  89   1       TR0=1;           //¶¨Ê±Æ÷¿ª¹Ø´ò¿ª
  90   1      }
  91          /*------------------------------------------------
  92                           ¶¨Ê±Æ÷ÖĞ¶Ï×Ó³ÌĞò
  93          ------------------------------------------------*/
  94          void Timer0_isr(void) interrupt 1 
  95          {
  96   1       static unsigned int num;
  97   1       TH0=(65536-2000)/256;            //ÖØĞÂ¸³Öµ 2ms
  98   1       TL0=(65536-2000)%256;
  99   1       
 100   1       num++;
 101   1       if(num==50)        //´óÖÂ100ms
 102   1         {
 103   2          num=0;
 104   2          ReadTimeFlag=1; //¶Á±êÖ¾Î»ÖÃ1
 105   2              }
 106   1      }
 107          
 108          /*------------------------------------------------
 109                            ´®¿ÚÖĞ¶Ï³ÌĞò
 110          ------------------------------------------------*/
 111          void UART_SER (void) interrupt 4 //´®ĞĞÖĞ¶Ï·şÎñ³ÌĞò
 112          {
 113   1          unsigned char Temp;          //¶¨ÒåÁÙÊ±±äÁ¿ 
 114   1          unsigned char i;
C51 COMPILER V8.02   MAIN                                                                  09/18/2010 23:34:57 PAGE 3   

 115   1          if(RI)                        //ÅĞ¶ÏÊÇ½ÓÊÕÖĞ¶Ï²úÉú
 116   1           {
 117   2                RI=0;                      //±êÖ¾Î»ÇåÁã
 118   2                Temp=SBUF;                 //¶ÁÈë»º³åÇøµÄÖµ
 119   2                time_buf2[i]=Temp&0x0F;
 120   2                i++;
 121   2                if(i==16)                  //Á¬Ğø½ÓÊÕ16¸ö×Ö·ûĞÅÏ¢
 122   2                 {
 123   3                  i=0;
 124   3                      SetFlag=1;               //½ÓÊÕÍê³É±êÖ¾Î»ÖÃ1
 125   3                 }
 126   2            SBUF=Temp; //°Ñ½ÓÊÕµ½µÄÖµÔÙ·¢»ØµçÄÔ¶Ë
 127   2               }
 128   1         if(TI)  //Èç¹ûÊÇ·¢ËÍ±êÖ¾Î»£¬ÇåÁã
 129   1           TI=0;
 130   1      } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    309    ----
   CONSTANT SIZE    =     43    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     18      17
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
