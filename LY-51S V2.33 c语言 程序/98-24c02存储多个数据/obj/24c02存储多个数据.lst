C51 COMPILER V7.06   24C02_______                                                     07/26/2011 17:45:20 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE 24C02_______
OBJECT MODULE PLACED IN .\obj\24c02洢.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE 24c02洢.c BROWSE DEBUG OBJECTEXTEND PRINT(.\obj\24c02洢
                    -.lst) OBJECT(.\obj\24c02洢.obj)

stmt level    source

   1          /*-----------------------------------------------
   2            ƣIICЭ EEPROM24c02
   3            ̳www.doflye.net
   4            дshifang
   5            ޸ģ
   6            ݣ˳ڼEEPROMܣԷ£д24c02һЩݣȻڴЩݣ
   7                  ڴ潫ʧȥЩϢȻ24c02еЩݡǷдͬ
   8                          ǲʱķSCL,̶Ը߾ƵҪ һ޸....(1us
   9                          ,ƵҪС12MHZ)
  10          ------------------------------------------------*/  
  11            
  12                        
  13          #include <reg52.h>          //ͷļİ
  14          #include <intrins.h>
  15          
  16          #define  _Nop()  _nop_()        //ָ
  17          
  18          // ,
  19          unsigned char code dofly_DuanMa[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f,
  20                                                           0x77,0x7c,0x39,0x5e,0x79,0x71};// ʾֵ0~F
  21          unsigned char code dofly_WeiMa[]={0xfe,0xfd,0xfb,0xf7,0xef,0xdf,0xbf,0x7f};//ֱӦӦܵ,λ
             -
  22          
  23          sbit LATCH1=P2^2;
  24          sbit LATCH2=P2^3;
  25                                                        
  26          sbit SDA=P2^1;            //ģI2Cݴλ
  27          sbit SCL=P2^0;            //ģI2Cʱӿλ
  28          
  29                                    
  30          bit ack;                      //Ӧ־λ
  31             
  32          
  33          void DelayUs2x(unsigned char t);// 
  34          void DelayMs(unsigned char t);
  35          
  36          /*------------------------------------------------
  37           uSʱ unsigned char t޷ֵ
  38           unsigned char Ƕ޷ֵַķΧ
  39           0~255 ʹþ12Mȷʱʹû,ʱ
  40            T=tx2+5 uS 
  41          ------------------------------------------------*/
  42          void DelayUs2x(unsigned char t)
  43          {   
  44   1       while(--t);
  45   1      }
  46          /*------------------------------------------------
  47           mSʱ unsigned char t޷ֵ
  48           unsigned char Ƕ޷ֵַķΧ
  49           0~255 ʹþ12Mȷʱʹû
  50          ------------------------------------------------*/
  51          void DelayMs(unsigned char t)
  52          {
  53   1           
C51 COMPILER V7.06   24C02_______                                                     07/26/2011 17:45:20 PAGE 2   

  54   1       while(t--)
  55   1       {
  56   2           //ʱ1mS
  57   2           DelayUs2x(245);
  58   2               DelayUs2x(245);
  59   2       }
  60   1      }
  61          
  62          /*------------------------------------------------
  63                              
  64          ------------------------------------------------*/
  65          void Start_I2c()
  66          {
  67   1        SDA=1;   //ʼź
  68   1        _Nop();
  69   1        SCL=1;
  70   1        _Nop();    //ʼʱ4.7us,ʱ
  71   1        _Nop();
  72   1        _Nop();
  73   1        _Nop();
  74   1        _Nop();    
  75   1        SDA=0;     //ʼź
  76   1        _Nop();    //ʼʱ4
  77   1        _Nop();
  78   1        _Nop();
  79   1        _Nop();
  80   1        _Nop();       
  81   1        SCL=0;    //ǯסI2Cߣ׼ͻ
  82   1        _Nop();
  83   1        _Nop();
  84   1      }
  85          /*------------------------------------------------
  86                              
  87          ------------------------------------------------*/
  88          void Stop_I2c()
  89          {
  90   1        SDA=0;    //ͽź
  91   1        _Nop();   //ͽʱź
  92   1        SCL=1;    //ʱ4
  93   1        _Nop();
  94   1        _Nop();
  95   1        _Nop();
  96   1        _Nop();
  97   1        _Nop();
  98   1        SDA=1;    //I2C߽ź
  99   1        _Nop();
 100   1        _Nop();
 101   1        _Nop();
 102   1        _Nop();
 103   1      }
 104          
 105          
 106          
 107          
 108          /*----------------------------------------------------------------
 109                           ֽݴͺ               
 110          ԭ: void  SendByte(unsigned char c);
 111          :  cͳȥ,ǵַ,Ҳ,ȴӦ,
 112               ״̬λв.(ӦӦʹack=0 )     
 113               ack=1; ack=0ʾӦ𻵡
 114          ------------------------------------------------------------------*/
 115          void  SendByte(unsigned char c)
C51 COMPILER V7.06   24C02_______                                                     07/26/2011 17:45:20 PAGE 3   

 116          {
 117   1       unsigned char BitCnt;
 118   1       
 119   1       for(BitCnt=0;BitCnt<8;BitCnt++)  //Ҫ͵ݳΪ8λ
 120   1          {
 121   2           if((c<<BitCnt)&0x80)SDA=1;   //жϷλ
 122   2             else  SDA=0;                
 123   2           _Nop();
 124   2           SCL=1;               //ʱΪߣ֪ͨʼλ
 125   2            _Nop(); 
 126   2            _Nop();             //֤ʱӸߵƽڴ4
 127   2            _Nop();
 128   2            _Nop();
 129   2            _Nop();         
 130   2           SCL=0; 
 131   2          }
 132   1          
 133   1          _Nop();
 134   1          _Nop();
 135   1          SDA=1;               //8λͷߣ׼Ӧλ
 136   1          _Nop();
 137   1          _Nop();   
 138   1          SCL=1;
 139   1          _Nop();
 140   1          _Nop();
 141   1          _Nop();
 142   1          if(SDA==1)ack=0;     
 143   1             else ack=1;        //жǷյӦź
 144   1          SCL=0;
 145   1          _Nop();
 146   1          _Nop();
 147   1      }
 148          
 149          
 150          
 151          
 152          
 153          
 154          
 155          /*----------------------------------------------------------------
 156                           ֽݴͺ               
 157          ԭ: unsigned char  RcvByte();
 158          :  մ,жߴ(Ӧź)
 159               Ӧ  
 160          ------------------------------------------------------------------*/    
 161          unsigned char  RcvByte()
 162          {
 163   1        unsigned char retc;
 164   1        unsigned char BitCnt;
 165   1        
 166   1        retc=0; 
 167   1        SDA=1;             //Ϊ뷽ʽ
 168   1        for(BitCnt=0;BitCnt<8;BitCnt++)
 169   1            {
 170   2              _Nop();           
 171   2              SCL=0;       //ʱΪͣ׼λ
 172   2              _Nop();
 173   2              _Nop();      //ʱӵ͵ƽڴ4.7us
 174   2              _Nop();
 175   2              _Nop();
 176   2              _Nop();
 177   2              SCL=1;       //ʱΪʹЧ
C51 COMPILER V7.06   24C02_______                                                     07/26/2011 17:45:20 PAGE 4   

 178   2              _Nop();
 179   2              _Nop();
 180   2              retc=retc<<1;
 181   2              if(SDA==1)retc=retc+1; //λ,յλretc
 182   2              _Nop();
 183   2              _Nop(); 
 184   2            }
 185   1        SCL=0;    
 186   1        _Nop();
 187   1        _Nop();
 188   1        return(retc);
 189   1      }
 190          
 191          
 192          
 193          /*----------------------------------------------------------------
 194                               ӦӺ
 195          ԭ:  void Ack_I2c(void);
 196           
 197          ----------------------------------------------------------------*/
 198          void Ack_I2c(void)
 199          {
 200   1        
 201   1        SDA=0;     
 202   1        _Nop();
 203   1        _Nop();
 204   1        _Nop();      
 205   1        SCL=1;
 206   1        _Nop();
 207   1        _Nop();              //ʱӵ͵ƽڴ4
 208   1        _Nop();
 209   1        _Nop();
 210   1        _Nop();  
 211   1        SCL=0;               //ʱߣǯסI2CԱ
 212   1        _Nop();
 213   1        _Nop();    
 214   1      }
 215          /*----------------------------------------------------------------
 216                               ӦӺ
 217          ԭ:  void NoAck_I2c(void);
 218           
 219          ----------------------------------------------------------------*/
 220          void NoAck_I2c(void)
 221          {
 222   1        
 223   1        SDA=1;
 224   1        _Nop();
 225   1        _Nop();
 226   1        _Nop();      
 227   1        SCL=1;
 228   1        _Nop();
 229   1        _Nop();              //ʱӵ͵ƽڴ4
 230   1        _Nop();
 231   1        _Nop();
 232   1        _Nop();  
 233   1        SCL=0;                //ʱߣǯסI2CԱ
 234   1        _Nop();
 235   1        _Nop();    
 236   1      }
 237          
 238          
 239          
C51 COMPILER V7.06   24C02_______                                                     07/26/2011 17:45:20 PAGE 5   

 240          
 241          
 242          
 243          /*----------------------------------------------------------------
 244                              ӵַֽݺ               
 245          ԭ: bit  ISendByte(unsigned char sla,ucahr c);  
 246          :     ߵ͵ַݣߵȫ,ַsla.
 247                     1ʾɹ
 248          ע⣺    ʹǰѽߡ
 249          ----------------------------------------------------------------*/
 250          /*bit ISendByte(unsigned char sla,unsigned char c)
 251          {
 252             Start_I2c();               //
 253             SendByte(sla);             //ַ
 254               if(ack==0)return(0);
 255             SendByte(c);               //
 256               if(ack==0)return(0);
 257            Stop_I2c();                 //
 258            return(1);
 259          }
 260          */
 261          
 262          /*----------------------------------------------------------------
 263                              ӵַͶֽݺ               
 264          ԭ: bit  ISendStr(unsigned char sla,unsigned char suba,ucahr *s,unsigned char no);  
 265          :     ߵ͵ַӵַ,ݣߵȫ,
 266                    ַslaӵַsubasָݣnoֽڡ
 267                     1ʾɹ
 268          ע⣺    ʹǰѽߡ
 269          ----------------------------------------------------------------*/
 270          bit ISendStr(unsigned char sla,unsigned char suba,unsigned char *s,unsigned char no)
 271          {
 272   1         unsigned char i;
 273   1      
 274   1         Start_I2c();               //
 275   1         SendByte(sla);             //ַ
 276   1           if(ack==0)return(0);
 277   1         SendByte(suba);            //ӵַ
 278   1           if(ack==0)return(0);
 279   1      
 280   1         for(i=0;i<no;i++)
 281   1          {   
 282   2           SendByte(*s);            //
 283   2           DelayMs(1);
 284   2             if(ack==0)return(0);
 285   2           s++;
 286   2          } 
 287   1       Stop_I2c();                  //
 288   1        return(1);
 289   1      }
 290          
 291          /*----------------------------------------------------------------
 292                              ӵַֽݺ               
 293          ԭ: bit  IRcvByte(unsigned char sla,ucahr *c);  
 294          :     ߵ͵ַݣߵȫ,
 295                    ַslaֵc.
 296                     1ʾɹ
 297          ע⣺    ʹǰѽߡ
 298          ----------------------------------------------------------------*/
 299          /*bit IRcvByte(unsigned char sla,unsigned char *c)
 300          {
 301             Start_I2c();                //
C51 COMPILER V7.06   24C02_______                                                     07/26/2011 17:45:20 PAGE 6   

 302             SendByte(sla+1);            //ַ
 303               if(ack==0)return(0);
 304             *c=RcvByte();               //ȡ
 305               NoAck_I2c();              //ͷǾʹλ
 306               Stop_I2c();               //
 307            return(1);
 308          }
 309          
 310          */
 311          /*----------------------------------------------------------------
 312                              ӵַȡֽݺ               
 313          ԭ: bit  ISendStr(unsigned char sla,unsigned char suba,ucahr *s,unsigned char no);  
 314          :     ߵ͵ַӵַ,ݣߵȫ,
 315                    ַslaӵַsubaݷsָĴ洢noֽڡ
 316                     1ʾɹ
 317          ע⣺    ʹǰѽߡ
 318          ----------------------------------------------------------------*/
 319          bit IRcvStr(unsigned char sla,unsigned char suba,unsigned char *s,unsigned char no)
 320          {
 321   1         unsigned char i;
 322   1      
 323   1         Start_I2c();               //
 324   1         SendByte(sla);             //ַ
 325   1           if(ack==0)return(0);
 326   1         SendByte(suba);            //ӵַ
 327   1           if(ack==0)return(0);
 328   1      
 329   1         Start_I2c();
 330   1         SendByte(sla+1);
 331   1            if(ack==0)return(0);
 332   1      
 333   1         for(i=0;i<no-1;i++)
 334   1          {   
 335   2           *s=RcvByte();              //
 336   2            Ack_I2c();                //;ʹλ 
 337   2           s++;
 338   2          } 
 339   1         *s=RcvByte();
 340   1          NoAck_I2c();                 //ͷӦλ
 341   1         Stop_I2c();                    //
 342   1        return(1);
 343   1      }
 344          /*------------------------------------------------
 345                              
 346          ------------------------------------------------*/
 347          void main()
 348                  {
 349   1               unsigned char dofly[4]={1,2,3,4};          // ʾֵ 1234
 350   1               unsigned char i;
 351   1               
 352   1               ISendStr(0xae,4,dofly,4);                   //д24c02
 353   1               DelayMs(200);
 354   1               dofly[0]=0;                                  //ǰ
 355   1               dofly[1]=0;
 356   1               dofly[2]=0;
 357   1               dofly[3]=0;
 358   1               IRcvStr(0xae,4,dofly,4);                  //ô洢
 359   1               
 360   1               while(1)
 361   1                    { 
 362   2                 
 363   2                     P0=dofly_DuanMa[dofly[i]];//ʾ洢
C51 COMPILER V7.06   24C02_______                                                     07/26/2011 17:45:20 PAGE 7   

 364   2                 LATCH1=1;                  //
 365   2                 LATCH1=0;
 366   2             
 367   2                         P0=dofly_WeiMa[i];  //ȡλ
 368   2                 LATCH2=1;          // 
 369   2                 LATCH2=0;
 370   2                         DelayMs(200);      //ʱʾʾ
 371   2                         DelayMs(200);
 372   2                         i++;
 373   2                         if(i==4)
 374   2                            i=0;
 375   2                        }
 376   1       }
 377          
 378          
 379          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    452    ----
   CONSTANT SIZE    =     28    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      17
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
